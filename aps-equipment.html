<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Калькулятор оборудования АПС</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0; /* Убираем все отступы */
            padding: 0; /* Убираем отступы для полноэкранного режима */
            width: 100vw; /* Занимаем всю ширину окна просмотра */
            overflow-x: hidden; /* Убираем горизонтальную прокрутку */
        }

        .container {
            width: 100vw; /* Занимаем всю ширину окна просмотра */
            max-width: none; /* Убираем ограничение максимальной ширины */
            margin: 0;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 0; /* Убираем скругление для полноэкранного режима */
            box-shadow: none; /* Убираем тень для полноэкранного режима */
            overflow: hidden;
            min-height: 100vh; /* Занимаем всю высоту экрана */
        }

        .header {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255,255,255,0.1) 10px,
                rgba(255,255,255,0.1) 20px
            );
            animation: slide 20s linear infinite;
        }

        @keyframes slide {
            0% { transform: translateX(-100px) translateY(-100px); }
            100% { transform: translateX(0px) translateY(0px); }
        }

        .header h1 {
            position: relative;
            z-index: 1;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            position: relative;
            z-index: 1;
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px; /* Уменьшаем промежутки для полноэкранного режима */
            padding: 10px 0; /* Убираем боковые отступы полностью для растягивания на весь экран */
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .section:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .section-title {
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9em;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e6ed;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .calculate-btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.3);
        }

        .results {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px; /* Уменьшаем отступы для полноэкранного режима */
            margin-top: 5px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .result-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .result-card h3 {
            margin-bottom: 15px;
            color: #fff;
            font-size: 1.2em;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-value {
            font-weight: 600;
            color: #ffd700;
        }

        .icon {
            font-size: 1.2em;
        }

        /* Стили для всплывающего окна */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-overlay.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e6ed;
        }

        .modal-title {
            font-size: 1.8em;
            color: #2c3e50;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2em;
            color: #999;
            cursor: pointer;
            transition: color 0.3s ease;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .modal-close:hover {
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        .apartments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .apartment-type {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #e0e6ed;
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .apartment-type:hover {
            border-color: #3498db;
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.15);
            transform: translateY(-2px);
        }

        .apartment-type h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .apartment-counter {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .counter-input {
            width: 80px;
            padding: 8px 12px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 1em;
            text-align: center;
            font-weight: 600;
            color: #2c3e50;
            transition: all 0.3s ease;
        }

        .counter-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .input-mode-toggle {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .input-mode-toggle:hover {
            background: #545b62;
        }

        .input-mode-toggle.active {
            background: #17a2b8;
        }

        .counter-btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .counter-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }

        .counter-btn:active {
            transform: scale(0.95);
        }

        .counter-display {
            min-width: 40px;
            text-align: center;
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3e50;
            background: white;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            padding: 8px;
        }

        .apartments-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .summary-row:last-child {
            margin-bottom: 0;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            font-weight: 600;
            font-size: 1.1em;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #545b62;
            transform: translateY(-2px);
        }

        .btn-primary {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
        }

        .open-modal-btn {
            background: linear-gradient(45deg, #17a2b8, #138496);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .open-modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(23, 162, 184, 0.3);
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                padding: 5px 0; /* Убираем боковые отступы на мобильных для полноэкранного режима */
            }

            .header h1 {
                font-size: 2em;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: 20px;
                width: calc(100% - 40px);
                max-height: calc(100vh - 40px);
            }

            .apartments-grid {
                grid-template-columns: 1fr;
            }

            .modal-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔥 Калькулятор АПС</h1>
            <p>Автоматическая пожарная сигнализация - Расчёт оборудования и кабеля</p>
        </div>

        <div class="main-content">
            <!-- Параметры объекта -->
            <div class="section">
                <h2 class="section-title">
                    <span class="icon">🏢</span>
                    Параметры объекта
                </h2>
                
                <div class="input-group">
                    <label for="above-ground-area">Площадь надземной части (м²)</label>
                    <input type="number" id="above-ground-area" value="800" placeholder="Жилые, офисные, коммерческие помещения">
                </div>

                <div class="input-group">
                    <label for="underground-area">Площадь подземной парковки (м²)</label>
                    <input type="number" id="underground-area" value="200" placeholder="Автомобильная парковка, технические помещения">
                </div>

                <div class="input-group">
                    <label for="total-area">Общая площадь объекта (м²)</label>
                    <input type="number" id="total-area" value="1000" readonly style="background-color: #e9ecef; cursor: not-allowed;" title="Рассчитывается автоматически как сумма надземной и подземной частей">
                </div>

                <div class="input-group">
                    <label for="above-ground-floors">Этажи надземной части</label>
                    <select id="above-ground-floors">
                        <!-- Создаем опции от 1 до 100 этажей -->
                        <script>
                            for (let i = 1; i <= 100; i++) {
                                document.write(`<option value="${i}" ${i === 3 ? 'selected' : ''}>${i}</option>`);
                            }
                        </script>
                    </select>
                </div>

                <div class="input-group">
                    <label for="underground-floors">Этажи подземной части</label>
                    <select id="underground-floors">
                        <!-- Создаем опции от 1 до 10 этажей -->
                        <script>
                            for (let i = 1; i <= 10; i++) {
                                document.write(`<option value="${i}" ${i === 1 ? 'selected' : ''}>${i}</option>`);
                            }
                        </script>
                    </select>
                </div>

                <div class="input-group">
                    <label for="floor-count">Общее количество этажей</label>
                    <input type="number" id="floor-count" value="4" readonly style="background-color: #e9ecef; cursor: not-allowed;" title="Рассчитывается автоматически как сумма надземных и подземных этажей">
                </div>


                <div class="input-group">
                    <label for="room-count">
                        Количество помещений
                        <small style="display: block; font-weight: normal; color: #666; font-size: 0.8em; margin-top: 4px;">
                            Общее количество помещений объекта
                        </small>
                    </label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" id="room-count" value="25" style="flex: 1;">
                        <button type="button" class="open-modal-btn" onclick="openRoomsModal()">
                            📊 Детально
                        </button>
                    </div>
                </div>

                <div class="input-group">
                    <label for="ceiling-height">Высота потолков (м)</label>
                    <input type="number" id="ceiling-height" step="0.1" value="3.0">
                </div>

                <div class="input-group">
                    <label for="building-type">Тип помещения</label>
                    <select id="building-type">
                        <optgroup label="🏠 Жилые помещения">
                            <option value="residential_apartment" selected>Квартиры жилого комплекса</option>
                        </optgroup>

                        <optgroup label="🚗 Хранение и парковка">
                            <option value="parking_underground">Подземный паркинг (Ф5.2)</option>
                            <option value="storage_individual">Индивидуальные кладовые</option>
                            <option value="waste_room">Мусоросборная камера</option>
                        </optgroup>

                        <optgroup label="⚙️ Технические/инженерные">
                            <option value="tech_ventilation">Венткамеры</option>
                            <option value="tech_heating">ИТП (тепловой пункт)</option>
                            <option value="tech_pumping">Насосная станция</option>
                            <option value="tech_transformer">Трансформаторная подстанция</option>
                            <option value="tech_electrical">Электрощитовые</option>
                            <option value="tech_telecom">Слаботочные системы (СС)</option>
                            <option value="tech_water">Водомерные узлы</option>
                            <option value="tech_floor">Технические этажи/пространства</option>
                        </optgroup>

                        <optgroup label="🛡️ Охрана и эксплуатация">
                            <option value="security_post">Пост охраны</option>
                            <option value="staff_room">Комната отдыха персонала</option>
                        </optgroup>

                        <optgroup label="📋 Стандартные типы">
                            <option value="office">Офисное здание</option>
                            <option value="warehouse">Складское помещение</option>
                            <option value="industrial">Производственное</option>
                            <option value="commercial">Торговое</option>
                        </optgroup>
                    </select>
                </div>

                <!-- Поле для количества квартир (показывается только для жилых зданий) -->
                <div class="input-group" id="apartments-section" style="display: block;">
                    <label for="apartments-count">
                        Количество квартир
                        <small style="display: block; font-weight: normal; color: #666; font-size: 0.8em; margin-top: 4px;">
                            Общее количество квартир в жилом комплексе
                        </small>
                    </label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" id="apartments-count" value="50" style="flex: 1;">
                        <button type="button" class="open-modal-btn" onclick="openApartmentsModal()">
                            📊 Детально
                        </button>
                    </div>
                </div>
            </div>

            <!-- Технические параметры -->
            <div class="section">
                <h2 class="section-title">
                    <span class="icon">⚙️</span>
                    Технические параметры
                </h2>

                <div class="input-group">
                    <label for="detector-coverage">
                        Площадь покрытия 1 датчика (м²)
                        <small style="display: block; font-weight: normal; color: #666; font-size: 0.8em; margin-top: 4px;">
                            Базовая площадь для расчета. Автоматически корректируется по СП 5.13130.2009
                        </small>
                    </label>
                    <input type="number" id="detector-coverage" value="25">
                </div>

                <div class="input-group">
                    <label for="manual-call-distance">Расстояние между ИПР (м)</label>
                    <input type="number" id="manual-call-distance" value="50">
                </div>

                <div class="input-group">
                    <label for="sounder-coverage">Радиус действия оповещателя (м)</label>
                    <input type="number" id="sounder-coverage" value="15">
                </div>

                <div class="input-group">
                    <label for="cable-reserve">Запас кабеля (%)</label>
                    <input type="number" id="cable-reserve" value="15">
                </div>

                <div class="input-group">
                    <label for="zone-size">Размер зоны (м²)</label>
                    <input type="number" id="zone-size" value="500">
                </div>

                <button class="calculate-btn" onclick="calculateEquipment()">
                    🧮 Рассчитать оборудование
                </button>
            </div>

            <!-- Результаты расчёта -->
            <div class="results" id="results" style="display: none;">
                <h2 class="section-title">
                    <span class="icon">📊</span>
                    Результаты расчёта
                </h2>
                
                <div class="results-grid">
                    <div class="result-card">
                        <h3>🔍 Датчики пожарной сигнализации</h3>
                        <div class="result-item">
                            <span>Извещатель дымовой ИП 212-64-R3 W2.02 Rubezh:</span>
                            <span class="result-value" id="smoke-detectors">0 шт.</span>
                        </div>
                        <div class="result-item">
                            <span>Извещатель тепловой (аналогичный модели):</span>
                            <span class="result-value" id="heat-detectors">0 шт.</span>
                        </div>
                        <div class="result-item">
                            <span>Общее количество датчиков:</span>
                            <span class="result-value" id="total-detectors">0 шт.</span>
                        </div>
                    </div>

                    <div class="result-card">
                        <h3>🚨 Устройства управления и оповещения</h3>
                        <div class="result-item">
                            <span>ППКОП 011249-2-1 "Рубеж-2ОП" прот.R3:</span>
                            <span class="result-value" id="control-panels">0 шт.</span>
                        </div>
                        <div class="result-item">
                            <span>Извещатель ручной пожарный АМ-4 прот. R3:</span>
                            <span class="result-value" id="manual-call-points">0 шт.</span>
                        </div>
                        <div class="result-item">
                            <span>Оповещатель ОПОП 124-R3 (светозвуковой):</span>
                            <span class="result-value" id="sounders">0 шт.</span>
                        </div>
                        <div class="result-item">
                            <span>Оповещатель световой МАЯК-24-СТ:</span>
                            <span class="result-value" id="beacons">0 шт.</span>
                        </div>
                    </div>

                    <div class="result-card">
                        <h3>🔌 Кабельная продукция</h3>
                        <div class="result-item">
                            <span>КСРЭПнг(А)-FRHF 1х2х0.97мм (шлейфы):</span>
                            <span class="result-value" id="loop-cable">0 м</span>
                        </div>
                        <div class="result-item">
                            <span>КПРПГнг(А)-FRHF 3х1.50 (питание):</span>
                            <span class="result-value" id="power-cable">0 м</span>
                        </div>
                        <div class="result-item">
                            <span>КПСнг(А)-FRHF 1х2х1.5 (оповещение):</span>
                            <span class="result-value" id="sounder-cable">0 м</span>
                        </div>
                    </div>

                    <div class="result-card">
                        <h3>💰 Дополнительное оборудование</h3>
                        <div class="result-item">
                            <span>ИВЭПР 24/2,5 RS-R3 (источники питания):</span>
                            <span class="result-value" id="power-supplies">0 шт.</span>
                        </div>
                        <div class="result-item">
                            <span>Аккумуляторы 12В 7Ач (резерв):</span>
                            <span class="result-value" id="batteries">0 шт.</span>
                        </div>
                        <div class="result-item">
                            <span>Релейные модули РМ-1/РМ-4-R3:</span>
                            <span class="result-value" id="relay-modules">0 шт.</span>
                        </div>
                        <div class="result-item">
                            <span>Метка адресная АМ-1-R3 Rubezh:</span>
                            <span class="result-value" id="boxes">0 шт.</span>
                        </div>
                        <div class="result-item">
                            <span>Изолятор шлейфа ИЗ-1Б-R3:</span>
                            <span class="result-value" id="isolators">0 шт.</span>
                        </div>
                    </div>

                    <div class="result-card">
                        <h3>🔧 Монтажные материалы</h3>
                        <div class="result-item">
                            <span>Труба гофрированная ПВХ d20мм:</span>
                            <span class="result-value" id="conduit">0 м</span>
                        </div>
                        <div class="result-item">
                            <span>Скоба металлическая СМО 19-26:</span>
                            <span class="result-value" id="brackets">0 шт.</span>
                        </div>
                        <div class="result-item">
                            <span>Анкер-клин 6х60мм металлический:</span>
                            <span class="result-value" id="anchors">0 шт.</span>
                        </div>
                    </div>

                    <div class="result-card">
                        <h3>🏢 Площади объекта</h3>
                        <div class="result-item">
                            <span>Надземная часть:</span>
                            <span class="result-value" id="above-area-result">0 м²</span>
                        </div>
                        <div class="result-item">
                            <span>Подземная парковка:</span>
                            <span class="result-value" id="underground-area-result">0 м²</span>
                        </div>
                        <div class="result-item">
                            <span>Общая площадь здания:</span>
                            <span class="result-value" id="total-area-result">0 м²</span>
                        </div>
                        <div class="result-item">
                            <span>Количество квартир:</span>
                            <span class="result-value" id="apartments-count-result">0 шт.</span>
                        </div>
                        <div class="result-item">
                            <span>Комнатность квартир:</span>
                            <span class="result-value" id="rooms-per-apartment-result">2-комнатные</span>
                        </div>
                        <div class="result-item">
                            <span>Общее количество комнат:</span>
                            <span class="result-value" id="total-rooms-result">0 шт.</span>
                        </div>
                        <div class="result-item">
                            <span>Этажи надземной части:</span>
                            <span class="result-value" id="above-ground-floors-result">3 этажей</span>
                        </div>
                        <div class="result-item">
                            <span>Этажи подземной части:</span>
                            <span class="result-value" id="underground-floors-result">1 этажей</span>
                        </div>
                        <div class="result-item">
                            <span>Общее количество этажей:</span>
                            <span class="result-value" id="total-floors-result">4 этажей</span>
                        </div>
                    </div>

                    <div class="result-card">
                        <h3>📊 Параметры системы R3-РУБЕЖ-2ОП</h3>
                        <div class="result-item">
                            <span>Расчётное количество зон (ЗКПС):</span>
                            <span class="result-value" id="zone-status">- / 500 макс.</span>
                        </div>
                        <div class="result-item">
                            <span>Длина АЛС (адресных линий связи):</span>
                            <span class="result-value" id="als-length">- / 3000м макс.</span>
                        </div>
                        <div class="result-item">
                            <span>Количество АЛС на прибор:</span>
                            <span class="result-value">2 линии × 3000м</span>
                        </div>
                        <div class="result-item">
                            <span>Площадь покрытия 1 датчика (расч.):</span>
                            <span class="result-value" id="detector-coverage-result">85 м²</span>
                        </div>
                    </div>

                    <div class="result-card">
                        <h3>📋 Алгоритмы и типы систем</h3>
                        <div class="result-item">
                            <span>Алгоритм работы датчиков:</span>
                            <span class="result-value" id="algorithm-type">-</span>
                        </div>
                        <div class="result-item">
                            <span>Тип системы оповещения (СОУЭ):</span>
                            <span class="result-value" id="soue-type">-</span>
                        </div>
                        <div class="result-item">
                            <span>Уровень звукового давления:</span>
                            <span class="result-value">75-120 дБА</span>
                        </div>
                    </div>

                    <div class="result-card">
                        <h3>📖 Нормативная база (СП 5.13130.2009)</h3>
                        <div class="result-item">
                            <span>Максимальная площадь на 1 дым. извещатель:</span>
                            <span class="result-value">85 м² (при h ≤ 3.5м)</span>
                        </div>
                        <div class="result-item">
                            <span>Расстояние между извещателями:</span>
                            <span class="result-value">≤ 9 м</span>
                        </div>
                        <div class="result-item">
                            <span>Расстояние до стен:</span>
                            <span class="result-value">≤ 4.5 м</span>
                        </div>
                        <div class="result-item">
                            <span>Корректировка по высоте:</span>
                            <span class="result-value" id="height-correction">Не требуется</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Всплывающее окно для детального выбора квартир -->
    <div class="modal-overlay" id="apartments-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    🏠 Детальный выбор квартир
                </h3>
                <button class="modal-close" onclick="closeApartmentsModal()">&times;</button>
            </div>

            <div style="margin-bottom: 20px; text-align: center;">
                <button class="input-mode-toggle" id="apartments-input-mode" onclick="toggleApartmentInputMode()">
                    📝 Ручной ввод
                </button>
            </div>

            <div class="apartments-grid">
                <div class="apartment-type">
                    <h4>🏠 1-комнатные</h4>
                    <div class="apartment-counter">
                        <div class="counter-controls" id="apartment1-room-counter">
                            <button class="counter-btn" onclick="changeCount('apartment1-room', -1)">-</button>
                            <div class="counter-display" id="apartment1-room-display">0</div>
                            <button class="counter-btn" onclick="changeCount('apartment1-room', 1)">+</button>
                        </div>
                        <input type="number" class="counter-input" id="apartment1-room-input" value="0" min="0"
                               style="display: none;" onchange="syncInputToCounter('apartment1-room')"
                               oninput="syncInputToCounter('apartment1-room')">
                    </div>
                </div>

                <div class="apartment-type">
                    <h4>🏡 2-комнатные</h4>
                    <div class="apartment-counter">
                        <div class="counter-controls" id="apartment2-room-counter">
                            <button class="counter-btn" onclick="changeCount('apartment2-room', -1)">-</button>
                            <div class="counter-display" id="apartment2-room-display">25</div>
                            <button class="counter-btn" onclick="changeCount('apartment2-room', 1)">+</button>
                        </div>
                        <input type="number" class="counter-input" id="apartment2-room-input" value="25" min="0"
                               style="display: none;" onchange="syncInputToCounter('apartment2-room')"
                               oninput="syncInputToCounter('apartment2-room')">
                    </div>
                </div>

                <div class="apartment-type">
                    <h4>🏘️ 3-комнатные</h4>
                    <div class="apartment-counter">
                        <div class="counter-controls" id="apartment3-room-counter">
                            <button class="counter-btn" onclick="changeCount('apartment3-room', -1)">-</button>
                            <div class="counter-display" id="apartment3-room-display">25</div>
                            <button class="counter-btn" onclick="changeCount('apartment3-room', 1)">+</button>
                        </div>
                        <input type="number" class="counter-input" id="apartment3-room-input" value="25" min="0"
                               style="display: none;" onchange="syncInputToCounter('apartment3-room')"
                               oninput="syncInputToCounter('apartment3-room')">
                    </div>
                </div>

                <div class="apartment-type">
                    <h4>🏰 4-комнатные</h4>
                    <div class="apartment-counter">
                        <div class="counter-controls" id="apartment4-room-counter">
                            <button class="counter-btn" onclick="changeCount('apartment4-room', -1)">-</button>
                            <div class="counter-display" id="apartment4-room-display">0</div>
                            <button class="counter-btn" onclick="changeCount('apartment4-room', 1)">+</button>
                        </div>
                        <input type="number" class="counter-input" id="apartment4-room-input" value="0" min="0"
                               style="display: none;" onchange="syncInputToCounter('apartment4-room')"
                               oninput="syncInputToCounter('apartment4-room')">
                    </div>
                </div>

                <div class="apartment-type">
                    <h4>🏛️ 5-комнатные</h4>
                    <div class="apartment-counter">
                        <div class="counter-controls" id="apartment5-room-counter">
                            <button class="counter-btn" onclick="changeCount('apartment5-room', -1)">-</button>
                            <div class="counter-display" id="apartment5-room-display">0</div>
                            <button class="counter-btn" onclick="changeCount('apartment5-room', 1)">+</button>
                        </div>
                        <input type="number" class="counter-input" id="apartment5-room-input" value="0" min="0"
                               style="display: none;" onchange="syncInputToCounter('apartment5-room')"
                               oninput="syncInputToCounter('apartment5-room')">
                    </div>
                </div>

                <div class="apartment-type">
                    <h4>🏰 6-комнатные</h4>
                    <div class="apartment-counter">
                        <div class="counter-controls" id="apartment6-room-counter">
                            <button class="counter-btn" onclick="changeCount('apartment6-room', -1)">-</button>
                            <div class="counter-display" id="apartment6-room-display">0</div>
                            <button class="counter-btn" onclick="changeCount('apartment6-room', 1)">+</button>
                        </div>
                        <input type="number" class="counter-input" id="apartment6-room-input" value="0" min="0"
                               style="display: none;" onchange="syncInputToCounter('apartment6-room')"
                               oninput="syncInputToCounter('apartment6-room')">
                    </div>
                </div>

                <div class="apartment-type">
                    <h4>🏯 7+ комнатные</h4>
                    <div class="apartment-counter">
                        <div class="counter-controls" id="apartment7-room-counter">
                            <button class="counter-btn" onclick="changeCount('apartment7-room', -1)">-</button>
                            <div class="counter-display" id="apartment7-room-display">0</div>
                            <button class="counter-btn" onclick="changeCount('apartment7-room', 1)">+</button>
                        </div>
                        <input type="number" class="counter-input" id="apartment7-room-input" value="0" min="0"
                               style="display: none;" onchange="syncInputToCounter('apartment7-room')"
                               oninput="syncInputToCounter('apartment7-room')">
                    </div>
                </div>
            </div>

            <div class="apartments-summary">
                <div class="summary-row">
                    <span>Общее количество квартир:</span>
                    <span id="total-apartments-summary">50</span>
                </div>
                <div class="summary-row">
                    <span>Общее количество комнат:</span>
                    <span id="total-rooms-summary">100</span>
                </div>
                <div class="summary-row">
                    <span>Средняя комнатность:</span>
                    <span id="average-rooms-summary">2.0</span>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn-secondary" onclick="resetApartments()">Сбросить</button>
                <button class="btn-primary" onclick="applyApartments()">Применить</button>
            </div>
        </div>
    </div>

    <!-- Всплывающее окно для детального выбора помещений -->
    <div class="modal-overlay" id="rooms-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    🏢 Детальный выбор помещений
                </h3>
                <button class="modal-close" onclick="closeRoomsModal()">&times;</button>
            </div>

            <div style="margin-bottom: 20px; text-align: center;">
                <button class="input-mode-toggle" id="rooms-input-mode" onclick="toggleRoomsInputMode()">
                    📝 Ручной ввод
                </button>
            </div>

            <div class="apartments-grid">
                <div class="apartment-type">
                    <h4>🏠 Жилые комнаты</h4>
                    <div class="apartment-counter">
                        <div class="counter-controls" id="residential-rooms-counter">
                            <button class="counter-btn" onclick="changeRoomCount('residential-rooms', -1)">-</button>
                            <div class="counter-display" id="residential-rooms-display">10</div>
                            <button class="counter-btn" onclick="changeRoomCount('residential-rooms', 1)">+</button>
                        </div>
                        <input type="number" class="counter-input" id="residential-rooms-input" value="10" min="0"
                               style="display: none;" onchange="syncRoomInputToCounter('residential-rooms')"
                               oninput="syncRoomInputToCounter('residential-rooms')">
                    </div>
                </div>

                <div class="apartment-type">
                    <h4>🍳 Кухни</h4>
                    <div class="apartment-counter">
                        <div class="counter-controls" id="kitchens-counter">
                            <button class="counter-btn" onclick="changeRoomCount('kitchens', -1)">-</button>
                            <div class="counter-display" id="kitchens-display">5</div>
                            <button class="counter-btn" onclick="changeRoomCount('kitchens', 1)">+</button>
                        </div>
                        <input type="number" class="counter-input" id="kitchens-input" value="5" min="0"
                               style="display: none;" onchange="syncRoomInputToCounter('kitchens')"
                               oninput="syncRoomInputToCounter('kitchens')">
                    </div>
                </div>

                <div class="apartment-type">
                    <h4>🚿 Санузлы</h4>
                    <div class="apartment-counter">
                        <div class="counter-controls" id="bathrooms-counter">
                            <button class="counter-btn" onclick="changeRoomCount('bathrooms', -1)">-</button>
                            <div class="counter-display" id="bathrooms-display">5</div>
                            <button class="counter-btn" onclick="changeRoomCount('bathrooms', 1)">+</button>
                        </div>
                        <input type="number" class="counter-input" id="bathrooms-input" value="5" min="0"
                               style="display: none;" onchange="syncRoomInputToCounter('bathrooms')"
                               oninput="syncRoomInputToCounter('bathrooms')">
                    </div>
                </div>

                <div class="apartment-type">
                    <h4>🚪 Коридоры/Прихожие</h4>
                    <div class="apartment-counter">
                        <div class="counter-controls" id="corridors-counter">
                            <button class="counter-btn" onclick="changeRoomCount('corridors', -1)">-</button>
                            <div class="counter-display" id="corridors-display">3</div>
                            <button class="counter-btn" onclick="changeRoomCount('corridors', 1)">+</button>
                        </div>
                        <input type="number" class="counter-input" id="corridors-input" value="3" min="0"
                               style="display: none;" onchange="syncRoomInputToCounter('corridors')"
                               oninput="syncRoomInputToCounter('corridors')">
                    </div>
                </div>

                <div class="apartment-type">
                    <h4>🏢 Офисные помещения</h4>
                    <div class="apartment-counter">
                        <div class="counter-controls" id="office-rooms-counter">
                            <button class="counter-btn" onclick="changeRoomCount('office-rooms', -1)">-</button>
                            <div class="counter-display" id="office-rooms-display">0</div>
                            <button class="counter-btn" onclick="changeRoomCount('office-rooms', 1)">+</button>
                        </div>
                        <input type="number" class="counter-input" id="office-rooms-input" value="0" min="0"
                               style="display: none;" onchange="syncRoomInputToCounter('office-rooms')"
                               oninput="syncRoomInputToCounter('office-rooms')">
                    </div>
                </div>

                <div class="apartment-type">
                    <h4>📦 Кладовые</h4>
                    <div class="apartment-counter">
                        <div class="counter-controls" id="storage-rooms-counter">
                            <button class="counter-btn" onclick="changeRoomCount('storage-rooms', -1)">-</button>
                            <div class="counter-display" id="storage-rooms-display">2</div>
                            <button class="counter-btn" onclick="changeRoomCount('storage-rooms', 1)">+</button>
                        </div>
                        <input type="number" class="counter-input" id="storage-rooms-input" value="2" min="0"
                               style="display: none;" onchange="syncRoomInputToCounter('storage-rooms')"
                               oninput="syncRoomInputToCounter('storage-rooms')">
                    </div>
                </div>

                <div class="apartment-type">
                    <h4>⚙️ Технические</h4>
                    <div class="apartment-counter">
                        <div class="counter-controls" id="technical-rooms-counter">
                            <button class="counter-btn" onclick="changeRoomCount('technical-rooms', -1)">-</button>
                            <div class="counter-display" id="technical-rooms-display">0</div>
                            <button class="counter-btn" onclick="changeRoomCount('technical-rooms', 1)">+</button>
                        </div>
                        <input type="number" class="counter-input" id="technical-rooms-input" value="0" min="0"
                               style="display: none;" onchange="syncRoomInputToCounter('technical-rooms')"
                               oninput="syncRoomInputToCounter('technical-rooms')">
                    </div>
                </div>

                <div class="apartment-type">
                    <h4>🏪 Коммерческие</h4>
                    <div class="apartment-counter">
                        <div class="counter-controls" id="commercial-rooms-counter">
                            <button class="counter-btn" onclick="changeRoomCount('commercial-rooms', -1)">-</button>
                            <div class="counter-display" id="commercial-rooms-display">0</div>
                            <button class="counter-btn" onclick="changeRoomCount('commercial-rooms', 1)">+</button>
                        </div>
                        <input type="number" class="counter-input" id="commercial-rooms-input" value="0" min="0"
                               style="display: none;" onchange="syncRoomInputToCounter('commercial-rooms')"
                               oninput="syncRoomInputToCounter('commercial-rooms')">
                    </div>
                </div>
            </div>

            <div class="apartments-summary">
                <div class="summary-row">
                    <span>Общее количество помещений:</span>
                    <span id="total-rooms-summary-modal">25</span>
                </div>
                <div class="summary-row">
                    <span>Жилых помещений:</span>
                    <span id="residential-total-summary">15</span>
                </div>
                <div class="summary-row">
                    <span>Нежилых помещений:</span>
                    <span id="non-residential-total-summary">10</span>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn-secondary" onclick="resetRooms()">Сбросить</button>
                <button class="btn-primary" onclick="applyRooms()">Применить</button>
            </div>
        </div>
    </div>

    <!-- Скрытые поля для детального режима -->
    <input type="hidden" id="apartment1-room" value="0">
    <input type="hidden" id="apartment2-room" value="25">
    <input type="hidden" id="apartment3-room" value="25">
    <input type="hidden" id="apartment4-room" value="0">
    <input type="hidden" id="apartment5-room" value="0">
    <input type="hidden" id="apartment6-room" value="0">
    <input type="hidden" id="apartment7-room" value="0">
    <input type="hidden" id="detailed-apartments" value="false">

    <!-- Скрытые поля для детального режима помещений -->
    <input type="hidden" id="residential-rooms" value="10">
    <input type="hidden" id="kitchens" value="5">
    <input type="hidden" id="bathrooms" value="5">
    <input type="hidden" id="corridors" value="3">
    <input type="hidden" id="office-rooms" value="0">
    <input type="hidden" id="storage-rooms" value="2">
    <input type="hidden" id="technical-rooms" value="0">
    <input type="hidden" id="commercial-rooms" value="0">
    <input type="hidden" id="detailed-rooms" value="false">

    <script>
        function calculateEquipment() {
            // Отладочное сообщение для проверки вызова функции
            console.log('calculateEquipment() вызвана');

            // Проверяем доступность ключевых элементов
            const testElements = [
                'above-ground-area', 'underground-area', 'building-type',
                'results', 'smoke-detectors', 'heat-detectors'
            ];

            let missingElements = [];
            testElements.forEach(id => {
                const element = document.getElementById(id);
                if (!element) {
                    missingElements.push(id);
                } else {
                    console.log(`Элемент ${id} найден:`, element);
                }
            });

            if (missingElements.length > 0) {
                alert('Отсутствуют элементы: ' + missingElements.join(', '));
                return;
            }

            alert('Функция calculateEquipment() запущена. Все элементы найдены.');

            // Получаем значения параметров площадей
            const aboveGroundArea = parseFloat(document.getElementById('above-ground-area').value) || 0;
            const undergroundArea = parseFloat(document.getElementById('underground-area').value) || 0;
            const area = aboveGroundArea + undergroundArea; // Общая площадь
            const aboveGroundFloors = parseInt(document.getElementById('above-ground-floors').value) || 3;
            const undergroundFloors = parseInt(document.getElementById('underground-floors').value) || 1;
            const totalFloors = aboveGroundFloors + undergroundFloors;
            const floors = parseInt(document.getElementById('floor-count').value) || totalFloors; // для совместимости
            // Получаем информацию о квартирах в зависимости от выбранного режима
            const useDetailedApartments = document.getElementById('detailed-apartments').value === 'true';
            let apartmentsCount, calculatedApartmentsCount, averageRoomsPerApartment;

            if (useDetailedApartments) {
                const apartment1Room = parseInt(document.getElementById('apartment1-room').value) || 0;
                const apartment2Room = parseInt(document.getElementById('apartment2-room').value) || 0;
                const apartment3Room = parseInt(document.getElementById('apartment3-room').value) || 0;
                const apartment4Room = parseInt(document.getElementById('apartment4-room').value) || 0;
                const apartment5Room = parseInt(document.getElementById('apartment5-room').value) || 0;
                const apartment6Room = parseInt(document.getElementById('apartment6-room').value) || 0;
                const apartment7Room = parseInt(document.getElementById('apartment7-room').value) || 0;

                calculatedApartmentsCount = apartment1Room + apartment2Room + apartment3Room + apartment4Room + apartment5Room + apartment6Room + apartment7Room;
                apartmentsCount = calculatedApartmentsCount;

                // Средняя комнатность при детальном режиме
                averageRoomsPerApartment = calculatedApartmentsCount > 0
                    ? (apartment1Room * 1 + apartment2Room * 2 + apartment3Room * 3 + apartment4Room * 4 + apartment5Room * 5 + apartment6Room * 6 + apartment7Room * 7) / calculatedApartmentsCount
                    : 2;

                // Сохраняем значения для использования в других местах
                window.apartmentDetails = {
                    apartment1Room, apartment2Room, apartment3Room, apartment4Room,
                    apartment5Room, apartment6Room, apartment7Room, useDetailedApartments
                };
            } else {
                apartmentsCount = parseInt(document.getElementById('apartments-count').value) || 50;
                calculatedApartmentsCount = apartmentsCount;
                averageRoomsPerApartment = 2; // Средняя комнатность для простого режима
                window.apartmentDetails = { useDetailedApartments: false };
            }
            // Получаем информацию о помещениях в зависимости от выбранного режима
            const useDetailedRooms = document.getElementById('detailed-rooms').value === 'true';
            let rooms, roomsBreakdown;

            if (useDetailedRooms) {
                // Детальный режим помещений
                roomsBreakdown = {
                    residential: parseInt(document.getElementById('residential-rooms').value) || 0,
                    kitchens: parseInt(document.getElementById('kitchens').value) || 0,
                    bathrooms: parseInt(document.getElementById('bathrooms').value) || 0,
                    corridors: parseInt(document.getElementById('corridors').value) || 0,
                    office: parseInt(document.getElementById('office-rooms').value) || 0,
                    storage: parseInt(document.getElementById('storage-rooms').value) || 0,
                    technical: parseInt(document.getElementById('technical-rooms').value) || 0,
                    commercial: parseInt(document.getElementById('commercial-rooms').value) || 0
                };

                rooms = roomsBreakdown.residential + roomsBreakdown.kitchens + roomsBreakdown.bathrooms +
                        roomsBreakdown.corridors + roomsBreakdown.office + roomsBreakdown.storage +
                        roomsBreakdown.technical + roomsBreakdown.commercial;

                // Сохраняем для использования в других местах
                window.roomsDetails = { ...roomsBreakdown, useDetailedRooms };
            } else {
                // Простой режим
                rooms = parseInt(document.getElementById('room-count').value) || 1;
                window.roomsDetails = { useDetailedRooms: false };
            }
            const height = parseFloat(document.getElementById('ceiling-height').value) || 3;
            const buildingType = document.getElementById('building-type').value;
            const detectorCoverage = parseFloat(document.getElementById('detector-coverage').value) || 25;
            const manualCallDistance = parseFloat(document.getElementById('manual-call-distance').value) || 50;
            const sounderCoverage = parseFloat(document.getElementById('sounder-coverage').value) || 15;
            const cableReserve = parseFloat(document.getElementById('cable-reserve').value) || 15;
            const zoneSize = parseFloat(document.getElementById('zone-size').value) || 500;

            // Расчёт зон контроля (ЗКПС) - основа для всех расчётов
            const zones = Math.ceil(area / zoneSize);
            console.log('Основные параметры:', { area, aboveGroundArea, undergroundArea, zones, buildingType });

            // Функция расчёта максимальной площади покрытия одним дымовым извещателем согласно СП 5.13130.2009
            function getMaxDetectorCoverage(ceilingHeight, baseArea = 85) {
                if (ceilingHeight <= 3.5) {
                    return baseArea;
                } else if (ceilingHeight <= 6.0) {
                    // При высоте 3.5-6м площадь уменьшается пропорционально
                    return Math.max(baseArea * (3.5 / ceilingHeight), 55);
                } else {
                    // При высоте свыше 6м - минимальная площадь
                    return 55;
                }
            }

            // Корректированная площадь покрытия с учетом высоты помещения
            const adjustedDetectorCoverage = getMaxDetectorCoverage(height);

            // Расчёт датчиков с учётом квартир и комнат для жилых зданий
            let totalDetectors;
            if (buildingType === 'residential_apartment') {
                if (useDetailedApartments) {
                    // Для детального режима: считаем датчики для каждого типа квартир
                    const detectors1Room = window.apartmentDetails.apartment1Room * (1 + 2); // комнаты + кухня + коридор
                    const detectors2Room = window.apartmentDetails.apartment2Room * (2 + 2); // комнаты + кухня + коридор
                    const detectors3Room = window.apartmentDetails.apartment3Room * (3 + 2); // комнаты + кухня + коридор
                    const detectors4Room = window.apartmentDetails.apartment4Room * (4 + 2); // комнаты + кухня + коридор
                    const detectors5Room = window.apartmentDetails.apartment5Room * (5 + 2); // комнаты + кухня + коридор
                    const detectors6Room = window.apartmentDetails.apartment6Room * (6 + 2); // комнаты + кухня + коридор
                    const detectors7Room = window.apartmentDetails.apartment7Room * (7 + 2); // комнаты + кухня + коридор

                    totalDetectors = detectors1Room + detectors2Room + detectors3Room + detectors4Room + detectors5Room + detectors6Room + detectors7Room;
                } else {
                    // Для простого режима: используем среднюю комнатность
                    const detectorsPerApartment = averageRoomsPerApartment + 2; // комнаты + кухня + коридор
                    totalDetectors = calculatedApartmentsCount * detectorsPerApartment;
                }

                // Добавляем датчики для общих зон (лестницы, коридоры)
                // Надземные этажи: 2 датчика на этаж, подземные: 1 датчик на этаж
                const aboveGroundCommonDetectors = Math.ceil(aboveGroundFloors * 2);
                const undergroundCommonDetectors = Math.ceil(undergroundFloors * 1);
                const commonAreaDetectors = aboveGroundCommonDetectors + undergroundCommonDetectors;
                totalDetectors += commonAreaDetectors;

                // Проверяем соответствие нормативу по площади (СП 5.13130.2009)
                const detectorsByArea = Math.ceil(area / adjustedDetectorCoverage);
                totalDetectors = Math.max(totalDetectors, detectorsByArea);
            } else {
                // Для остальных типов помещений - по площади с учётом высоты потолков
                totalDetectors = Math.ceil(area / adjustedDetectorCoverage);
            }

            // Разделение на типы датчиков по принципам безопасности
            let smokeDetectors, heatDetectors, algorithmType;
            switch(buildingType) {
                // Жилые помещения
                case 'residential_apartment':
                    // Квартиры - преимущественно дымовые для раннего обнаружения
                    // В спальнях и гостиных только дымовые, на кухне - тепловые
                    const kitchenHeatDetectors = calculatedApartmentsCount; // по 1 тепловому на кухню
                    heatDetectors = kitchenHeatDetectors;
                    smokeDetectors = totalDetectors - heatDetectors;
                    algorithmType = 'B (двойное срабатывание ≤60с)';
                    break;

                // Хранение и парковка
                case 'parking_underground':
                    // Подземный паркинг - особые требования по алгоритму С
                    smokeDetectors = Math.ceil(totalDetectors * 0.6);
                    heatDetectors = Math.ceil(totalDetectors * 0.4);
                    algorithmType = 'С (два разных типа ИП)';
                    break;
                case 'storage_individual':
                    // Кладовые - смешанный тип с учётом хранимых материалов
                    smokeDetectors = Math.ceil(totalDetectors * 0.7);
                    heatDetectors = Math.ceil(totalDetectors * 0.3);
                    algorithmType = 'B (двойное срабатывание ≤60с)';
                    break;
                case 'waste_room':
                    // Мусоросборная - повышенная пожароопасность
                    smokeDetectors = Math.ceil(totalDetectors * 0.8);
                    heatDetectors = Math.ceil(totalDetectors * 0.2);
                    algorithmType = 'B (двойное срабатывание ≤60с)';
                    break;

                // Технические помещения
                case 'tech_ventilation':
                case 'tech_heating':
                case 'tech_pumping':
                case 'tech_water':
                case 'tech_floor':
                    // Технические помещения - больше тепловых из-за оборудования
                    smokeDetectors = Math.ceil(totalDetectors * 0.4);
                    heatDetectors = Math.ceil(totalDetectors * 0.6);
                    algorithmType = 'B (двойное срабатывание ≤60с)';
                    break;
                case 'tech_transformer':
                case 'tech_electrical':
                    // Электрические помещения - специальные требования
                    smokeDetectors = Math.ceil(totalDetectors * 0.3);
                    heatDetectors = Math.ceil(totalDetectors * 0.7);
                    algorithmType = 'B (двойное срабатывание ≤60с)';
                    break;
                case 'tech_telecom':
                    // Слаботочные системы - преимущественно дымовые
                    smokeDetectors = Math.ceil(totalDetectors * 0.9);
                    heatDetectors = Math.ceil(totalDetectors * 0.1);
                    algorithmType = 'B (двойное срабатывание ≤60с)';
                    break;

                // Охрана и эксплуатация
                case 'security_post':
                case 'staff_room':
                    // Помещения персонала - как офисные
                    smokeDetectors = Math.ceil(totalDetectors * 0.8);
                    heatDetectors = Math.ceil(totalDetectors * 0.2);
                    algorithmType = 'B (двойное срабатывание ≤60с)';
                    break;

                // Стандартные типы (для совместимости)
                case 'warehouse':
                    smokeDetectors = Math.ceil(totalDetectors * 0.3);
                    heatDetectors = Math.ceil(totalDetectors * 0.7);
                    algorithmType = 'B (двойное срабатывание ≤60с)';
                    break;
                case 'industrial':
                    smokeDetectors = Math.ceil(totalDetectors * 0.4);
                    heatDetectors = Math.ceil(totalDetectors * 0.6);
                    algorithmType = 'B (двойное срабатывание ≤60с)';
                    break;
                case 'residential':
                    smokeDetectors = Math.ceil(totalDetectors * 0.9);
                    heatDetectors = Math.ceil(totalDetectors * 0.1);
                    algorithmType = 'B (двойное срабатывание ≤60с)';
                    break;
                case 'commercial':
                    smokeDetectors = Math.ceil(totalDetectors * 0.85);
                    heatDetectors = Math.ceil(totalDetectors * 0.15);
                    algorithmType = 'B (двойное срабатывание ≤60с)';
                    break;
                default: // office
                    smokeDetectors = Math.ceil(totalDetectors * 0.8);
                    heatDetectors = Math.ceil(totalDetectors * 0.2);
                    algorithmType = 'B (двойное срабатывание ≤60с)';
                    break;
            }

            // Расчёт ППКОП R3-РУБЕЖ-2ОП на основе технических характеристик
            // Один прибор: до 500 пожарных зон, 2 АЛС × 3000м каждая
            const maxZonesPerPanel = 500; // Максимум зон на один прибор
            const maxLineLength = 3000; // Максимальная длина одной АЛС в метрах
            const linesPerPanel = 2; // Количество АЛС на один прибор

            // Расчёт по зонам
            const panelsByZones = Math.ceil(zones / maxZonesPerPanel);

            // Расчёт по длине линий (примерная длина АЛС на основе площади)
            // Расчёт длины кабеля с учётом раздельной этажности
            const aboveGroundLineLength = Math.sqrt(aboveGroundArea) * aboveGroundFloors * 1.5;
            const undergroundLineLength = Math.sqrt(undergroundArea) * undergroundFloors * 2.0; // Подземка сложнее для прокладки
            const estimatedLineLength = aboveGroundLineLength + undergroundLineLength;
            const requiredLines = Math.ceil(estimatedLineLength / maxLineLength) * Math.ceil(zones / 100); // Дополнительные линии для больших объектов
            const panelsByLineLength = Math.ceil(requiredLines / linesPerPanel);

            // Итоговое количество приборов (по максимальному ограничению)
            const controlPanels = Math.max(1, panelsByZones, panelsByLineLength);

            // Ручные извещатели (алгоритм А - одноразовое срабатывание)
            const perimeter = 2 * Math.sqrt(area * 2); // примерный периметр здания
            const manualCallPoints = Math.ceil(perimeter / manualCallDistance) + Math.ceil(rooms / 4);

            // Система оповещения по типам помещений (СОУЭ)
            let sounderMultiplier, soueType;
            switch(buildingType) {
                // Жилые помещения
                case 'residential_apartment':
                    soueType = '3-й тип (жилые секции)';
                    sounderMultiplier = 1.0; // Стандартное покрытие для жилых помещений
                    break;

                // Хранение и парковка
                case 'parking_underground':
                    soueType = '4-й тип (парковка)';
                    sounderMultiplier = 1.4; // Увеличенное из-за большой площади и акустики
                    break;
                case 'storage_individual':
                    soueType = '2-й тип (кладовые)';
                    sounderMultiplier = 1.1; // Стандартное с небольшим запасом
                    break;
                case 'waste_room':
                    soueType = '2-й тип (техпомещения)';
                    sounderMultiplier = 1.2; // Повышенные требования из-за опасности
                    break;

                // Технические помещения
                case 'tech_ventilation':
                case 'tech_heating':
                case 'tech_pumping':
                case 'tech_water':
                case 'tech_floor':
                case 'tech_transformer':
                case 'tech_electrical':
                case 'tech_telecom':
                    soueType = '2-й тип (техпомещения)';
                    sounderMultiplier = 1.2; // Увеличенное из-за шума оборудования
                    break;

                // Охрана и эксплуатация
                case 'security_post':
                case 'staff_room':
                    soueType = '3-й тип (административные)';
                    sounderMultiplier = 1.0; // Стандартное покрытие как для офисов
                    break;

                // Стандартные типы (для совместимости)
                case 'warehouse':
                    soueType = '2-й тип (техпомещения)';
                    sounderMultiplier = 1.2;
                    break;
                case 'industrial':
                    soueType = '2-й тип (техпомещения)';
                    sounderMultiplier = 1.3;
                    break;
                case 'residential':
                    soueType = '3-й тип (жилые секции)';
                    sounderMultiplier = 1.0;
                    break;
                case 'commercial':
                    soueType = '3-й тип (торговые)';
                    sounderMultiplier = 1.1;
                    break;
                default: // office
                    soueType = '3-й тип (офисные)';
                    sounderMultiplier = 1.0;
                    break;
            }

            // Расчёт оповещателей с учётом уровня звука ≥75 дБА, но ≤120 дБА
            const sounderArea = Math.PI * Math.pow(sounderCoverage, 2);
            const sounders = Math.ceil((area / sounderArea) * sounderMultiplier);
            const beacons = Math.ceil(sounders * 0.5); // 50% световых оповещателей

            // Источники питания ИВЭПР 24/2,5 RS-R3 - отдельный для каждой панели ППКОП
            const powerSupplies = controlPanels; // По одному источнику питания на каждую панель
            const batteries = powerSupplies * 2; // По 2 аккумулятора 12В 7Ач на источник питания

            // Дополнительные релейные модули для управления системами
            const relayModules = Math.ceil(zones / 10); // РМ-1/РМ-4 для управления оборудованием

            // Монтажные коробки - для всех устройств на шлейфах
            const boxes = Math.ceil((totalDetectors + manualCallPoints + sounders + beacons) / 2);

            // Расчёт кабеля с учётом требований АЛС R3-РУБЕЖ-2ОП
            const cableMultiplier = 1 + (cableReserve / 100); // Запас кабеля

            // КСРЭПнг(А)-FRHF для АЛС (адресные линии связи)
            // Длина АЛС ≤ 3000м на линию, 2 линии на прибор
            const alsLength = Math.min(estimatedLineLength, maxLineLength * linesPerPanel);
            const loopCable = Math.ceil(controlPanels * alsLength * cableMultiplier);

            // КПРПГнг(А)-FRHF для питания панелей и источников питания
            const avgPowerRun = Math.sqrt(area) * 0.3; // Средняя длина до щитовых
            const powerCable = Math.ceil(controlPanels * avgPowerRun * cableMultiplier);

            // КПСнг(А)-FRHF для линий оповещения
            const avgSounderRun = Math.sqrt(area) * 0.5; // Длина линий оповещения
            const sounderCable = Math.ceil(sounders * avgSounderRun * 0.7 * cableMultiplier);

            // Обновляем результаты
            console.log('Начинаем обновление результатов...');
            try {
                document.getElementById('smoke-detectors').textContent = `${smokeDetectors} шт.`;
                document.getElementById('heat-detectors').textContent = `${heatDetectors} шт.`;
                document.getElementById('total-detectors').textContent = `${totalDetectors} шт.`;
                document.getElementById('control-panels').textContent = `${controlPanels} шт.`;
                document.getElementById('manual-call-points').textContent = `${manualCallPoints} шт.`;
                document.getElementById('sounders').textContent = `${sounders} шт.`;
                document.getElementById('beacons').textContent = `${beacons} шт.`;
                document.getElementById('power-supplies').textContent = `${powerSupplies} шт.`;
                document.getElementById('batteries').textContent = `${batteries} шт.`;
                document.getElementById('boxes').textContent = `${boxes} шт.`;
                document.getElementById('zones').textContent = `${zones} зон`;
                document.getElementById('loop-cable').textContent = `${loopCable} м`;
                document.getElementById('power-cable').textContent = `${powerCable} м`;
                document.getElementById('sounder-cable').textContent = `${sounderCable} м`;
                document.getElementById('algorithm-type').textContent = algorithmType;
                document.getElementById('soue-type').textContent = soueType;
                console.log('Основные результаты обновлены успешно');

            // Расчёт дополнительного оборудования и монтажных материалов
            document.getElementById('relay-modules').textContent = `${relayModules} шт.`;
            document.getElementById('isolators').textContent = `${Math.ceil(zones/2)} шт.`;
            document.getElementById('conduit').textContent = `${Math.ceil(totalDetectors * 10)} м`;
            document.getElementById('brackets').textContent = `${Math.ceil(totalDetectors * 15)} шт.`;
            document.getElementById('anchors').textContent = `${Math.ceil(totalDetectors * 8)} шт.`;

            // Площади объекта
            document.getElementById('above-area-result').textContent = `${aboveGroundArea} м²`;
            document.getElementById('underground-area-result').textContent = `${undergroundArea} м²`;

            // Данные о квартирах
            document.getElementById('apartments-count-result').textContent = `${calculatedApartmentsCount} шт.`;

            // Обновляем информацию о составе квартир
            if (useDetailedApartments) {
                let apartmentDetails = '';
                if (window.apartmentDetails.apartment1Room > 0) apartmentDetails += `1к: ${window.apartmentDetails.apartment1Room} шт. (${window.apartmentDetails.apartment1Room} ком); `;
                if (window.apartmentDetails.apartment2Room > 0) apartmentDetails += `2к: ${window.apartmentDetails.apartment2Room} шт. (${window.apartmentDetails.apartment2Room * 2} ком); `;
                if (window.apartmentDetails.apartment3Room > 0) apartmentDetails += `3к: ${window.apartmentDetails.apartment3Room} шт. (${window.apartmentDetails.apartment3Room * 3} ком); `;
                if (window.apartmentDetails.apartment4Room > 0) apartmentDetails += `4к: ${window.apartmentDetails.apartment4Room} шт. (${window.apartmentDetails.apartment4Room * 4} ком); `;
                if (window.apartmentDetails.apartment5Room > 0) apartmentDetails += `5к: ${window.apartmentDetails.apartment5Room} шт. (${window.apartmentDetails.apartment5Room * 5} ком); `;
                if (window.apartmentDetails.apartment6Room > 0) apartmentDetails += `6к: ${window.apartmentDetails.apartment6Room} шт. (${window.apartmentDetails.apartment6Room * 6} ком); `;
                if (window.apartmentDetails.apartment7Room > 0) apartmentDetails += `7к: ${window.apartmentDetails.apartment7Room} шт. (${window.apartmentDetails.apartment7Room * 7} ком); `;

                document.getElementById('rooms-per-apartment-result').textContent = apartmentDetails.slice(0, -2) || 'Не указано';

                const totalRooms = window.apartmentDetails.apartment1Room * 1 +
                                   window.apartmentDetails.apartment2Room * 2 +
                                   window.apartmentDetails.apartment3Room * 3 +
                                   window.apartmentDetails.apartment4Room * 4 +
                                   window.apartmentDetails.apartment5Room * 5 +
                                   window.apartmentDetails.apartment6Room * 6 +
                                   window.apartmentDetails.apartment7Room * 7;
                document.getElementById('total-rooms-result').textContent = `${totalRooms} шт. (сред: ${averageRoomsPerApartment.toFixed(1)})`;
            } else {
                document.getElementById('rooms-per-apartment-result').textContent = `${averageRoomsPerApartment}-комнатные (средне)`;
                document.getElementById('total-rooms-result').textContent = `${Math.ceil(calculatedApartmentsCount * averageRoomsPerApartment)} шт.`;
            }

            // Данные об этажности
            document.getElementById('above-ground-floors-result').textContent = `${aboveGroundFloors} этажей`;
            document.getElementById('underground-floors-result').textContent = `${undergroundFloors} этажей`;
            document.getElementById('total-floors-result').textContent = `${totalFloors} этажей`;
            document.getElementById('total-area-result').textContent = `${area} м²`;

            // Параметры системы R3-РУБЕЖ-2ОП
            document.getElementById('zone-status').textContent = `${zones} / ${maxZonesPerPanel} макс.`;
            document.getElementById('als-length').textContent = `${Math.ceil(alsLength)} / 3000м макс.`;
            document.getElementById('detector-coverage-result').textContent = `${adjustedDetectorCoverage.toFixed(1)} м²`;

                // Корректировка по высоте
                document.getElementById('height-correction').textContent =
                    height > 3.5 ? `Применена (${height}м > 3.5м)` : 'Не требуется';

                console.log('Все результаты обновлены успешно');
            } catch (error) {
                console.error('Ошибка при обновлении результатов:', error);
                alert('Ошибка при обновлении результатов: ' + error.message);
                return; // Выходим из функции при ошибке
            }

            // Отладочная информация перед отображением результатов
            console.log('Расчёт завершён. Результаты:');
            console.log('- Дымовые датчики:', smokeDetectors);
            console.log('- Тепловые датчики:', heatDetectors);
            console.log('- Общее количество датчиков:', totalDetectors);
            console.log('- Площадь:', area);

            // Проверяем существование элемента results
            const resultsElement = document.getElementById('results');
            if (resultsElement) {
                console.log('Элемент results найден, показываем результаты');
                console.log('До изменения display:', resultsElement.style.display);
                resultsElement.style.display = 'block';
                console.log('После изменения display:', resultsElement.style.display);

                // Прокручиваем к результатам
                resultsElement.scrollIntoView({ behavior: 'smooth' });

                // Дополнительная проверка видимости
                setTimeout(() => {
                    const computedStyle = window.getComputedStyle(resultsElement);
                    console.log('Computed display:', computedStyle.display);
                    console.log('Результаты должны быть видны!');
                    alert('Результаты расчёта отображены. Проверьте страницу.');
                }, 100);
            } else {
                console.error('Элемент results не найден!');
                alert('Ошибка: элемент для отображения результатов не найден');
            }
        }

        // Функция обновления общей площади
        function updateTotalArea() {
            const aboveGround = parseFloat(document.getElementById('above-ground-area').value) || 0;
            const underground = parseFloat(document.getElementById('underground-area').value) || 0;
            const total = aboveGround + underground;
            document.getElementById('total-area').value = total;
        }

        // Функция для обновления общего количества этажей
        function updateTotalFloors() {
            const aboveGround = parseInt(document.getElementById('above-ground-floors').value) || 0;
            const underground = parseInt(document.getElementById('underground-floors').value) || 0;
            const total = aboveGround + underground;
            document.getElementById('floor-count').value = total;
        }

        // Обработчики для автоматического обновления общей площади
        document.getElementById('above-ground-area').addEventListener('input', updateTotalArea);
        document.getElementById('underground-area').addEventListener('input', updateTotalArea);

        // Обработчики для автоматического обновления общего количества этажей
        document.getElementById('above-ground-floors').addEventListener('change', updateTotalFloors);
        document.getElementById('underground-floors').addEventListener('change', updateTotalFloors);


        // Автоматический расчёт при изменении значений
        document.querySelectorAll('input, select').forEach(input => {
            input.addEventListener('input', () => {
                updateTotalArea(); // Обновляем общую площадь
                updateTotalFloors(); // Обновляем общее количество этажей
                if(document.getElementById('results').style.display !== 'none') {
                    calculateEquipment();
                }
            });
        });

        // Функции для работы с всплывающим окном квартир
        function openApartmentsModal() {
            // Синхронизируем значения с главной формой
            syncModalWithForm();
            // Показываем модальное окно
            const modal = document.getElementById('apartments-modal');
            modal.classList.add('show');
            // Обновляем итоги
            updateModalSummary();
        }

        function closeApartmentsModal() {
            // Скрываем модальное окно
            const modal = document.getElementById('apartments-modal');
            modal.classList.remove('show');
        }

        function changeCount(apartmentType, delta) {
            // Получаем текущее значение
            const input = document.getElementById(apartmentType);
            const display = document.getElementById(apartmentType + '-display');
            let currentValue = parseInt(input.value) || 0;

            // Изменяем значение (не даем уйти в минус)
            const newValue = Math.max(0, currentValue + delta);

            // Обновляем скрытое поле и отображение
            input.value = newValue;
            display.textContent = newValue;

            // Обновляем итоги
            updateModalSummary();
        }

        function updateModalSummary() {
            // Получаем все значения квартир
            const apartments = {
                apartment1Room: parseInt(document.getElementById('apartment1-room').value) || 0,
                apartment2Room: parseInt(document.getElementById('apartment2-room').value) || 0,
                apartment3Room: parseInt(document.getElementById('apartment3-room').value) || 0,
                apartment4Room: parseInt(document.getElementById('apartment4-room').value) || 0,
                apartment5Room: parseInt(document.getElementById('apartment5-room').value) || 0,
                apartment6Room: parseInt(document.getElementById('apartment6-room').value) || 0,
                apartment7Room: parseInt(document.getElementById('apartment7-room').value) || 0
            };

            // Считаем итоги
            const totalApartments = apartments.apartment1Room + apartments.apartment2Room +
                                    apartments.apartment3Room + apartments.apartment4Room +
                                    apartments.apartment5Room + apartments.apartment6Room +
                                    apartments.apartment7Room;

            const totalRooms = apartments.apartment1Room * 1 + apartments.apartment2Room * 2 +
                               apartments.apartment3Room * 3 + apartments.apartment4Room * 4 +
                               apartments.apartment5Room * 5 + apartments.apartment6Room * 6 +
                               apartments.apartment7Room * 7;

            const averageRooms = totalApartments > 0 ? (totalRooms / totalApartments).toFixed(1) : 0;

            // Обновляем отображение итогов
            document.getElementById('total-apartments-summary').textContent = totalApartments;
            document.getElementById('total-rooms-summary').textContent = totalRooms;
            document.getElementById('average-rooms-summary').textContent = averageRooms;
        }

        function syncModalWithForm() {
            // Проверяем, используется ли детальный режим
            const isDetailed = document.getElementById('detailed-apartments').value === 'true';

            if (!isDetailed) {
                // Если не детальный режим, распределяем квартиры по умолчанию
                const totalApartments = parseInt(document.getElementById('apartments-count').value) || 0;
                // Распределяем 50% на 2-комнатные, 50% на 3-комнатные
                const half = Math.floor(totalApartments / 2);

                document.getElementById('apartment1-room').value = 0;
                document.getElementById('apartment2-room').value = half;
                document.getElementById('apartment3-room').value = totalApartments - half;
                document.getElementById('apartment4-room').value = 0;
                document.getElementById('apartment5-room').value = 0;
                document.getElementById('apartment6-room').value = 0;
                document.getElementById('apartment7-room').value = 0;
            }

            // Синхронизируем отображение в модальном окне
            ['apartment1-room', 'apartment2-room', 'apartment3-room', 'apartment4-room',
             'apartment5-room', 'apartment6-room', 'apartment7-room'].forEach(id => {
                const value = document.getElementById(id).value;
                document.getElementById(id + '-display').textContent = value;
            });
        }

        function resetApartments() {
            // Сбрасываем все значения к нулю
            ['apartment1-room', 'apartment2-room', 'apartment3-room', 'apartment4-room',
             'apartment5-room', 'apartment6-room', 'apartment7-room'].forEach(id => {
                document.getElementById(id).value = 0;
                document.getElementById(id + '-display').textContent = 0;
            });

            // Обновляем итоги
            updateModalSummary();
        }

        function applyApartments() {
            // Включаем детальный режим
            document.getElementById('detailed-apartments').value = 'true';

            // Обновляем общее количество квартир в основной форме
            const totalApartments = parseInt(document.getElementById('total-apartments-summary').textContent) || 0;
            document.getElementById('apartments-count').value = totalApartments;

            // Закрываем модальное окно
            closeApartmentsModal();

            // Перезапускаем расчёт если результаты уже отображены
            if(document.getElementById('results').style.display !== 'none') {
                calculateEquipment();
            }
        }

        // Функция для скрытия/показа секции квартир в зависимости от типа здания
        function toggleApartmentsSection() {
            const buildingType = document.getElementById('building-type').value;
            const apartmentsSection = document.getElementById('apartments-section');

            if (buildingType === 'residential_apartment') {
                apartmentsSection.style.display = 'block';
            } else {
                apartmentsSection.style.display = 'none';
                // Сбрасываем детальный режим при переключении на другой тип здания
                document.getElementById('detailed-apartments').value = 'false';
            }
        }

        // Добавляем обработчик изменения типа здания
        document.getElementById('building-type').addEventListener('change', toggleApartmentsSection);

        // Закрытие модального окна по клику на фон
        document.getElementById('apartments-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeApartmentsModal();
            }
        });

        // Функции для работы с всплывающим окном помещений
        function openRoomsModal() {
            // Синхронизируем значения с главной формой
            syncRoomsModalWithForm();
            // Показываем модальное окно
            const modal = document.getElementById('rooms-modal');
            modal.classList.add('show');
            // Обновляем итоги
            updateRoomsModalSummary();
        }

        function closeRoomsModal() {
            // Скрываем модальное окно
            const modal = document.getElementById('rooms-modal');
            modal.classList.remove('show');
        }

        function changeRoomCount(roomType, delta) {
            // Получаем текущее значение
            const input = document.getElementById(roomType);
            const display = document.getElementById(roomType + '-display');
            let currentValue = parseInt(input.value) || 0;

            // Изменяем значение (не даем уйти в минус)
            const newValue = Math.max(0, currentValue + delta);

            // Обновляем скрытое поле и отображение
            input.value = newValue;
            display.textContent = newValue;

            // Обновляем итоги
            updateRoomsModalSummary();
        }

        function updateRoomsModalSummary() {
            // Получаем все значения помещений
            const rooms = {
                residential: parseInt(document.getElementById('residential-rooms').value) || 0,
                kitchens: parseInt(document.getElementById('kitchens').value) || 0,
                bathrooms: parseInt(document.getElementById('bathrooms').value) || 0,
                corridors: parseInt(document.getElementById('corridors').value) || 0,
                office: parseInt(document.getElementById('office-rooms').value) || 0,
                storage: parseInt(document.getElementById('storage-rooms').value) || 0,
                technical: parseInt(document.getElementById('technical-rooms').value) || 0,
                commercial: parseInt(document.getElementById('commercial-rooms').value) || 0
            };

            // Считаем итоги
            const totalRooms = rooms.residential + rooms.kitchens + rooms.bathrooms + rooms.corridors +
                               rooms.office + rooms.storage + rooms.technical + rooms.commercial;

            const residentialTotal = rooms.residential + rooms.kitchens + rooms.bathrooms + rooms.corridors;
            const nonResidentialTotal = rooms.office + rooms.storage + rooms.technical + rooms.commercial;

            // Обновляем отображение итогов
            document.getElementById('total-rooms-summary-modal').textContent = totalRooms;
            document.getElementById('residential-total-summary').textContent = residentialTotal;
            document.getElementById('non-residential-total-summary').textContent = nonResidentialTotal;
        }

        function syncRoomsModalWithForm() {
            // Проверяем, используется ли детальный режим
            const isDetailed = document.getElementById('detailed-rooms').value === 'true';

            if (!isDetailed) {
                // Если не детальный режим, распределяем помещения по умолчанию
                const totalRooms = parseInt(document.getElementById('room-count').value) || 0;

                // Распределяем помещения по типам (примерное распределение)
                const residential = Math.floor(totalRooms * 0.4); // 40% жилые комнаты
                const kitchens = Math.floor(totalRooms * 0.2); // 20% кухни
                const bathrooms = Math.floor(totalRooms * 0.2); // 20% санузлы
                const corridors = Math.floor(totalRooms * 0.12); // 12% коридоры
                const storage = totalRooms - residential - kitchens - bathrooms - corridors; // остальное в кладовые

                document.getElementById('residential-rooms').value = residential;
                document.getElementById('kitchens').value = kitchens;
                document.getElementById('bathrooms').value = bathrooms;
                document.getElementById('corridors').value = corridors;
                document.getElementById('office-rooms').value = 0;
                document.getElementById('storage-rooms').value = storage;
                document.getElementById('technical-rooms').value = 0;
                document.getElementById('commercial-rooms').value = 0;
            }

            // Синхронизируем отображение в модальном окне
            ['residential-rooms', 'kitchens', 'bathrooms', 'corridors',
             'office-rooms', 'storage-rooms', 'technical-rooms', 'commercial-rooms'].forEach(id => {
                const value = document.getElementById(id).value;
                document.getElementById(id + '-display').textContent = value;
            });
        }

        function resetRooms() {
            // Сбрасываем все значения к нулю
            ['residential-rooms', 'kitchens', 'bathrooms', 'corridors',
             'office-rooms', 'storage-rooms', 'technical-rooms', 'commercial-rooms'].forEach(id => {
                document.getElementById(id).value = 0;
                document.getElementById(id + '-display').textContent = 0;
            });

            // Обновляем итоги
            updateRoomsModalSummary();
        }

        function applyRooms() {
            // Включаем детальный режим
            document.getElementById('detailed-rooms').value = 'true';

            // Обновляем общее количество помещений в основной форме
            const totalRooms = parseInt(document.getElementById('total-rooms-summary-modal').textContent) || 0;
            document.getElementById('room-count').value = totalRooms;

            // Закрываем модальное окно
            closeRoomsModal();

            // Перезапускаем расчёт если результаты уже отображены
            if(document.getElementById('results').style.display !== 'none') {
                calculateEquipment();
            }
        }

        // Закрытие модального окна помещений по клику на фон
        document.getElementById('rooms-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeRoomsModal();
            }
        });

        // Функции для переключения режимов ввода в окне квартир
        function toggleApartmentInputMode() {
            const button = document.getElementById('apartments-input-mode');
            const apartmentTypes = ['apartment1-room', 'apartment2-room', 'apartment3-room', 'apartment4-room',
                                  'apartment5-room', 'apartment6-room', 'apartment7-room'];

            const isInputMode = button.classList.contains('active');

            apartmentTypes.forEach(type => {
                const counter = document.getElementById(type + '-counter');
                const input = document.getElementById(type + '-input');

                if (isInputMode) {
                    // Переключаемся на счетчики
                    counter.style.display = 'flex';
                    input.style.display = 'none';
                    button.textContent = '📝 Ручной ввод';
                    button.classList.remove('active');
                } else {
                    // Переключаемся на ручной ввод
                    counter.style.display = 'none';
                    input.style.display = 'block';
                    button.textContent = '🔢 Счетчики';
                    button.classList.add('active');
                    // Синхронизируем значения
                    input.value = document.getElementById(type).value;
                }
            });
        }

        function syncInputToCounter(apartmentType) {
            const input = document.getElementById(apartmentType + '-input');
            const hiddenField = document.getElementById(apartmentType);
            const display = document.getElementById(apartmentType + '-display');

            // Валидация: только положительные числа
            let value = parseInt(input.value) || 0;
            if (value < 0) value = 0;

            // Обновляем все связанные поля
            hiddenField.value = value;
            display.textContent = value;
            input.value = value;

            // Обновляем итоги
            updateModalSummary();
        }

        // Функции для переключения режимов ввода в окне помещений
        function toggleRoomsInputMode() {
            const button = document.getElementById('rooms-input-mode');
            const roomTypes = ['residential-rooms', 'kitchens', 'bathrooms', 'corridors',
                             'office-rooms', 'storage-rooms', 'technical-rooms', 'commercial-rooms'];

            const isInputMode = button.classList.contains('active');

            roomTypes.forEach(type => {
                const counter = document.getElementById(type + '-counter');
                const input = document.getElementById(type + '-input');

                if (isInputMode) {
                    // Переключаемся на счетчики
                    counter.style.display = 'flex';
                    input.style.display = 'none';
                    button.textContent = '📝 Ручной ввод';
                    button.classList.remove('active');
                } else {
                    // Переключаемся на ручной ввод
                    counter.style.display = 'none';
                    input.style.display = 'block';
                    button.textContent = '🔢 Счетчики';
                    button.classList.add('active');
                    // Синхронизируем значения
                    input.value = document.getElementById(type).value;
                }
            });
        }

        function syncRoomInputToCounter(roomType) {
            const input = document.getElementById(roomType + '-input');
            const hiddenField = document.getElementById(roomType);
            const display = document.getElementById(roomType + '-display');

            // Валидация: только положительные числа
            let value = parseInt(input.value) || 0;
            if (value < 0) value = 0;

            // Обновляем все связанные поля
            hiddenField.value = value;
            display.textContent = value;
            input.value = value;

            // Обновляем итоги
            updateRoomsModalSummary();
        }

        // Обновляем функции changeCount и changeRoomCount для синхронизации с полями ввода
        const originalChangeCount = changeCount;
        changeCount = function(apartmentType, delta) {
            originalChangeCount(apartmentType, delta);
            // Синхронизируем с полем ввода, если оно видимо
            const input = document.getElementById(apartmentType + '-input');
            if (input && input.style.display !== 'none') {
                input.value = document.getElementById(apartmentType).value;
            }
        };

        const originalChangeRoomCount = changeRoomCount;
        changeRoomCount = function(roomType, delta) {
            originalChangeRoomCount(roomType, delta);
            // Синхронизируем с полем ввода, если оно видимо
            const input = document.getElementById(roomType + '-input');
            if (input && input.style.display !== 'none') {
                input.value = document.getElementById(roomType).value;
            }
        };

        // Функция для синхронизации при открытии модальных окон
        function syncApartmentInputs() {
            const apartmentTypes = ['apartment1-room', 'apartment2-room', 'apartment3-room', 'apartment4-room',
                                  'apartment5-room', 'apartment6-room', 'apartment7-room'];

            apartmentTypes.forEach(type => {
                const input = document.getElementById(type + '-input');
                const hiddenField = document.getElementById(type);
                if (input && hiddenField) {
                    input.value = hiddenField.value;
                }
            });
        }

        function syncRoomInputs() {
            const roomTypes = ['residential-rooms', 'kitchens', 'bathrooms', 'corridors',
                             'office-rooms', 'storage-rooms', 'technical-rooms', 'commercial-rooms'];

            roomTypes.forEach(type => {
                const input = document.getElementById(type + '-input');
                const hiddenField = document.getElementById(type);
                if (input && hiddenField) {
                    input.value = hiddenField.value;
                }
            });
        }

        // Переопределяем функции открытия модальных окон для синхронизации
        function openApartmentsModalWithSync() {
            openApartmentsModal();
            syncApartmentInputs();
        }

        function openRoomsModalWithSync() {
            openRoomsModal();
            syncRoomInputs();
        }

        // Инициализация - проверяем начальное состояние
        document.addEventListener('DOMContentLoaded', function() {
            toggleApartmentsSection();
            updateModalSummary();
            updateRoomsModalSummary();
            syncApartmentInputs();
            syncRoomInputs();
        });
    </script>
</body>
</html>